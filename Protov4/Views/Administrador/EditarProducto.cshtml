@using Protov4.DTO;
@{
    Layout = "~/Views/Administrador/_LayoutAdmin.cshtml";
}
@model List<ProductoDTO>
<h1>Editar Producto</h1>

<div class="flex-container">
    @foreach (var prod in Model)
    {

        var imagenBytes = prod.Imagen;
        var base64 = "data:image/png;base64," + Convert.ToBase64String(imagenBytes);
        
        <form id="crearProductoForm" method="post" enctype="multipart/form-data" action="@Url.Action("EditarProductoDAO", "Administrador")">
            <input hidden value="@prod.Id" id="_id" name="_id">
            <label class="Texto1Form" for="nombre">Nombre Producto</label><br>
            <input class="Boton1Form" type="text" id="nombre" name="nombre" value="@prod.Nombre_Producto" required><br />
            <label class="Texto1Form" for="imagen">Imagen</label><br>
            <input class="Boton1Form" type="file" id="imagen" name="imagen" accept="image/*"><br>
            <img id="imagen-preview" src=@base64 alt="Vista Previa de la Imagen" style="max-width: 200px;"><br>
            <input hidden id="imagenBase64" name="imagenBase64" value="@base64">


            <label class="Texto1Form" for="precio">Precio</label><br>
            <div class="input-container">
                <input class="Boton1Form" type="number" id="precio" name="precio" required value="@prod.Precio" min="1" step="1" inputmode="numeric">
                <span class="error-message" id="precio-error">Ingrese un valor válido</span>
            </div><br>

            <label class="Texto1Form" for="existencia">Existencias</label><br>
            <div class="input-container">
                <input class="Boton1Form" type="number" id="existencia" value="@prod.Existencia" name="existencia" required min="0" step="1" inputmode="numeric">
                <span class="error-message" id="existencia-error">Ingrese un valor válido</span>
            </div><br>


            <div class="input-container">
                <label class="Texto1Form" for="marca">Marca</label><br>
                <input class="Boton1Form" type="text" id="marca" value="@prod.Marca" name="Marca" required><br>
            </div>
            <div class="input-container">
                <label class="Texto1Form" for="Tipo">Tipo</label><br>
                <select class="ComboForm" id="Tipo" name="tipo" required>
                    <option value="Procesador">Procesador</option>
                    <option value="Almacenamiento">Almacenamiento</option>
                    <option value="Ram">Ram</option>
                    <option value="Fuente">Fuente</option>
                    <option value="Placa">Placa</option>
                    <option value="Gráfica">Gráfica</option>
                </select><br />
            </div>
            <h4 class="espe">Especificaciones</h4>
            <!-- Campos específicos para cada tipo -->
            <div id="tipo-specific" class="hidden">
                <!-- Campos específicos para todos los tipos de productos -->
                <div class="input-container">
                    <label class="Texto1Form" id="lblvelocidad" for="velocidad">Velocidad</label>
                    <input class="Boton1Form" type="text" id="velocidad" name="Velocidad" value="@prod.Especificaciones.Velocidad" >
                </div>
                <div class="input-container">
                    <label class="Texto1Form" id="lblfabricante" for="fabricante">Fabricante</label>
                    <input class="Boton1Form" type="text" id="fabricante" name="Fabricante" value="@prod.Especificaciones.Fabricante">
                </div>
                <label class="Texto1Form" id="lblmodelo" for="modelo">Modelo</label>
                <input class="Boton1Form" type="text" id="modelo" name="Modelo" value="@prod.Especificaciones.Modelo">
                <div class="input-container">
                    <label class="Texto1Form" id="lblzocalo" for="zocalo">Zócalo</label>
                    <input class="Boton1Form" type="text" id="zocalo" name="Zocalo" value="@prod.Especificaciones.Zócalo" >
                </div>
                <label class="Texto1Form" id="lblvram" for="tamanioVram">Tamaño VRAM</label>
                <input class="Boton1Form" type="text" id="tamanioVram" name="TamanioVram" value="@prod.Especificaciones.TamañoVRAM">
                <div class="input-container">
                    <label class="Texto1Form" id="lblinterfaz" for="interfaz">Interfaz</label>
                    <input class="Boton1Form" type="text" id="interfaz" name="Interfaz" value="@prod.Especificaciones.Interfaz">
                </div>
                <label class="Texto1Form" id="lblalmacenamiento">Almacenamiento</label>
                <input class="Boton1Form" type="text" id="almacenamiento" name="Almacenamiento" value="@prod.Especificaciones.Almacenamiento">
                <div class="input-container">
                    <label class="Texto1Form" id="lbltecnologiaRam" for="tecnologiaRam">Tecnología RAM</label>
                    <input class="Boton1Form" type="text" id="tecnologiaRam" name="TecnologiaRam" value="@prod.Especificaciones.TecnologíaRAM">
                </div>
                <div class="input-container">
                    <label class="Texto1Form" id="lbltamañomemoria">Tamaño Memoria</label>
                    <input class="Boton1Form" type="text" id="tamanioMemoria" name="TamanioMemoria" value="@prod.Especificaciones.Tamañomemoria"><br>
                </div>

            </div>
            <label class="Texto1Form" for="descripcion">Descripción</label><br>
            <table id="descripcionTable">
                <tbody>
                    @for (int i = 0; i < prod.Especificaciones.Descripción.Count; i++)
                    {
                        <tr>
                            <td>
                                <input class="Boton1Form descripcion" type="text" name="Descripcion[@i]" value="@prod.Especificaciones.Descripción[i]">
                            </td>
                            <td>
                                <button type="button" class="btn btn-danger remove-row">Eliminar</button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
            <button type="button" class="btn btn-secondary add-row">Agregar Descripción</button>
            <input type="hidden" name="NuevasDescripcionesJson" id="nuevasDescripcionesJson" />

            <button class="btn btn-primary" type="submit"><i class="bi bi-save2-fill"></i>Guardar</button>
        </form>
    }
</div>



 <script>
    document.addEventListener('DOMContentLoaded', function () {
        var tipoSelect = document.getElementById('Tipo');
        var camposEspecificos = document.getElementById('tipo-specific');
        var camposFabricante = document.getElementById('fabricante');
        var camposModelo = document.getElementById('modelo');
        var camposZocalo = document.getElementById('zocalo');
        var camposInterfaz = document.getElementById('interfaz');
        var camposVelocidad = document.getElementById('velocidad');
        var camposTamañoVram = document.getElementById('tamanioVram');
        var camposAlmacenamiento = document.getElementById('almacenamiento');
        var campostecnologiaRam = document.getElementById('tecnologiaRam');
        var campostamanioMemoria = document.getElementById('tamanioMemoria');
        var lblCampoVelocidad = document.getElementById('lblvelocidad');
        var lblzocalo = document.getElementById('lblzocalo');
        var lblfabricante = document.getElementById('lblfabricante');
        var lblmodelo = document.getElementById('lblmodelo');
        var lblvram = document.getElementById('lblvram');
        var lblinterfaz = document.getElementById('lblinterfaz');
        var lblalmacenamiento = document.getElementById('lblalmacenamiento');
        var lbltecnologiaRam = document.getElementById('lbltecnologiaRam');
        var lbltamaniomemoria = document.getElementById('lbltamañomemoria');
        function hideAllSpecificFields() {
            lblzocalo.style.display = 'none';
            lblCampoVelocidad.style.display = 'none';
            camposFabricante.style.display = 'none';
            camposModelo.style.display = 'none';
            camposZocalo.style.display = 'none';
            camposInterfaz.style.display = 'none';
            camposVelocidad.style.display = 'none';
            camposTamañoVram.style.display = 'none';
            camposAlmacenamiento.style.display = 'none';
            campostecnologiaRam.style.display = 'none';
            campostamanioMemoria.style.display = 'none';
            lblfabricante.style.display = 'none';
            lblmodelo.style.display = 'none';
            lblvram.style.display = 'none';
            lblinterfaz.style.display = 'none';
            lblalmacenamiento.style.display = 'none';
            lbltamaniomemoria.style.display = 'none';
            lbltecnologiaRam.style.display = 'none';
        }
        var descriptionTable = document.getElementById('descripcionTable');
        var addRowButton = document.querySelector('.add-row');

        addRowButton.addEventListener('click', function () {
            var newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td>
                    <input class="Boton1Form descripcion" type="text" name="NuevasDescripciones[]" />
                </td>
                <td>
                    <button type="button" class="btn btn-link remove-row">Eliminar</button>
                </td>`;
            descriptionTable.querySelector('tbody').appendChild(newRow);
        });

        // Removing a row from the table
        descripcionTable.addEventListener('click', function (event) {
            if (event.target.classList.contains('remove-row')) {
                event.target.closest('tr').remove();
            }
        });

        // ...Other code...

        // Submitting the form
        var crearProductoForm = document.getElementById('crearProductoForm');

        crearProductoForm.addEventListener('submit', function () {
            event.preventDefault(); // Prevent the default form submission

            // Show a SweetAlert confirmation
            Swal.fire({
                title: 'Confirmar edición',
                text: '¿Estás seguro de que quieres editar este producto?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Sí, editar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    // If user confirms, proceed with form submission
                    var descripcionInputs = document.querySelectorAll('.Boton1Form.descripcion');
                    var nuevasDescripciones = [];

                    descripcionInputs.forEach(function (input) {
                        nuevasDescripciones.push(input.value);
                    });

                    var nuevasDescripcionesJsonInput = document.getElementById('nuevasDescripcionesJson');
                    nuevasDescripcionesJsonInput.value = JSON.stringify(nuevasDescripciones);
                    var precioInput = document.getElementById('precio');
                    var precioValor = parseFloat(precioInput.value);

                    // Now you can submit the form
                    crearProductoForm.submit();
                }
            });
        });
        hideAllSpecificFields();

        tipoSelect.addEventListener('change', function () {
            hideAllSpecificFields();

            var selectedValue = tipoSelect.value;

            if (selectedValue === "Procesador") {
                lblCampoVelocidad.style.display = 'block';
                lblfabricante.style.display = 'block';
                lblmodelo.style.display = 'block';
                lblzocalo.style.display = 'block';
                camposEspecificos.style.display = 'block';
                camposFabricante.style.display = 'block';
                camposModelo.style.display = 'block';
                camposVelocidad.style.display = 'block';
                camposZocalo.style.display = 'block';
                camposFabricante.required = true;
                camposModelo.required = true;
                camposZocalo.required = true;
                camposInterfaz.required = false;
                camposVelocidad.required = true;
                camposTamañoVram.required = false;
                camposAlmacenamiento.required = false;
                campostecnologiaRam.required = false;
                campostamanioMemoria.required = false;

            } else if (selectedValue === "Gráfica") {
                lblCampoVelocidad.style.display = 'block';
                lblfabricante.style.display = 'block';
                lblmodelo.style.display = 'block';
                lblvram.style.display = 'block';
                lblinterfaz.style.display = 'block';
                camposEspecificos.style.display = 'block';
                camposFabricante.style.display = 'block';
                camposModelo.style.display = 'block';
                camposInterfaz.style.display = 'block';
                camposVelocidad.style.display = 'block';
                camposTamañoVram.style.display = 'block';
                camposFabricante.required = true;
                camposModelo.required = true;
                camposZocalo.required = false;
                camposInterfaz.required = true;
                camposVelocidad.required = true;
                camposTamañoVram.required = true;
                camposAlmacenamiento.required = false;
                campostecnologiaRam.required = false;
                campostamanioMemoria.required = false;

            } else if (selectedValue === "Ram") {
                lblCampoVelocidad.style.display = 'block';
                lblfabricante.style.display = 'block';
                lblmodelo.style.display = 'block';
                lbltecnologiaRam.style.display = 'block';
                lbltamaniomemoria.style.display = 'block';
                camposEspecificos.style.display = 'block';
                camposFabricante.style.display = 'block';
                camposModelo.style.display = 'block';
                campostamanioMemoria.style.display = 'block';
                camposVelocidad.style.display = 'block';
                campostecnologiaRam.style.display = 'block';
                camposFabricante.required = true;
                camposModelo.required = true;
                camposZocalo.required = false;
                camposInterfaz.required = false;
                camposVelocidad.required = true;
                camposTamañoVram.required = false;
                camposAlmacenamiento.required = false;
                campostecnologiaRam.required = true;
                campostamanioMemoria.required = true;

            } else if (selectedValue === "Fuente") {

                lblfabricante.style.display = 'block';

                camposFabricante.style.display = 'block';
                camposFabricante.required = true;
                camposModelo.required = false;
                camposZocalo.required = false;
                camposInterfaz.required = false;
                camposVelocidad.required = false;
                camposTamañoVram.required = false;
                camposAlmacenamiento.required = false;
                campostecnologiaRam.required = false;
                campostamanioMemoria.required = false;

            } else if (selectedValue === "Almacenamiento") {
                lblfabricante.style.display = 'block';
                lblinterfaz.style.display = 'block';
                lblalmacenamiento.style.display = 'block';

                camposEspecificos.style.display = 'block';
                camposFabricante.style.display = 'block';
                camposInterfaz.style.display = 'block';
                camposAlmacenamiento.style.display = 'block';
                camposFabricante.required = true;
                camposModelo.required = false;
                camposZocalo.required = false;
                camposInterfaz.required = true;
                camposVelocidad.required = false;
                camposTamañoVram.required = false;
                camposAlmacenamiento.required = true;
                campostecnologiaRam.required = false;
                campostamanioMemoria.required = false;
            } else if (selectedValue === "Placa") {
                lblfabricante.style.display = 'block';
                lblmodelo.style.display = 'block';
                lblzocalo.style.display = 'block';
                lbltecnologiaRam.style.display = 'block';

                camposEspecificos.style.display = 'block';
                camposFabricante.style.display = 'block';
                camposModelo.style.display = 'block';
                camposZocalo.style.display = 'block';
                campostecnologiaRam.style.display = 'block';
                camposFabricante.required = true;
                camposModelo.required = true;
                camposZocalo.required = true;
                camposInterfaz.required = false;
                camposVelocidad.required = true;
                camposTamañoVram.required = false;
                camposAlmacenamiento.required = false;
                campostecnologiaRam.required = false;
                campostamanioMemoria.required = false;
            }
        });
        var camposDinamicosHidden = document.getElementById('campos-dinamicos-hidden');
     

        // Seleccionar el valor por defecto
        var defaultTipoValue = '@Model[0].Tipo';

        tipoSelect.value = defaultTipoValue;

        tipoSelect.dispatchEvent(new Event('change'));

        var imagenInput = document.getElementById('imagen');
        var imagenPreview = document.getElementById('imagen-preview');
        var imagenBase64Actual = document.getElementById('imagenBase64');

        imagenInput.addEventListener('change', function () {
            var file = imagenInput.files[0];
            if (file) {
                var reader = new FileReader();
                reader.onload = function (e) {
                    var newBase64 = e.target.result;
                    imagenBase64.value = newBase64;
                    imagenPreview.src = newBase64;
                };
                reader.readAsDataURL(file);
            }
        });
    });
 </script>
